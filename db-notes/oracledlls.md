-- Oracle DB DDL schema


-- User-related data


CREATE TABLE USERS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 Name VARCHAR2(32) NOT NULL, -- Note: names are not unique
 RegistrationDate TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
 CONSTRAINT PK_USERS PRIMARY KEY (Id)
);


CREATE TABLE FRIENDSHIPS (
 UserId NUMBER(8,0) NOT NULL,
 FriendId NUMBER(8,0) NOT NULL,
 CONSTRAINT PK_FRIENDSHIPS PRIMARY KEY (UserId, FriendId),
 CONSTRAINT FK_FREINDSHIPS_USER FOREIGN KEY (UserId) REFERENCES USERS(Id) ON DELETE CASCADE,
 CONSTRAINT FK_FREINDSHIPS_FRIEND FOREIGN KEY (FriendId) REFERENCES USERS(Id) ON DELETE CASCADE
);


-- Business-related data


CREATE TABLE BUSINESSES (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 Name VARCHAR2(64) NOT NULL,
 Street VARCHAR2(120), -- Note: data doesn't always contain street information
 City VARCHAR2(64) NOT NULL,
 State VARCHAR2(5) NOT NULL,
 PostalCode VARCHAR2(10), -- Note: data doesn't always contain postal code information
 PositionLatitude NUMBER(10,6), -- Note: data doesn't always contain position information
 PositionLongitude NUMBER(10,6), -- same as above
 CONSTRAINT PK_BUSINESSES PRIMARY KEY (Id)
);


CREATE TABLE TAGS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 Name VARCHAR2(64) NOT NULL,
 CONSTRAINT PK_TAGS PRIMARY KEY (Id)
);


CREATE TABLE CATEGORIES (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 Name VARCHAR2(64) NOT NULL,
 CONSTRAINT PK_CATEGORIES PRIMARY KEY (Id)
);


CREATE TABLE BUSINESS_TAGS (
 BusinessId NUMBER(8,0) NOT NULL,
 TagId NUMBER(8,0) NOT NULL,
 CONSTRAINT PK_BUSINESS_TAGS PRIMARY KEY (BusinessId, TagId),
 CONSTRAINT FK_BUSINESS_TAGS_BUSINESSES FOREIGN KEY (BusinessId) REFERENCES BUSINESSES(Id),
 CONSTRAINT FK_BUSINESS_TAGS_TAGS FOREIGN KEY (TagId) REFERENCES TAGS(Id)
);


CREATE TABLE BUSINESS_CATEGORIES (
   BusinessId NUMBER(8,0) NOT NULL,
   CategoryId NUMBER(8,0) NOT NULL,
   CONSTRAINT PK_BUSINESS_CATEGORIES PRIMARY KEY (BusinessId, CategoryId),
   CONSTRAINT FK_BUSINESS_CATEGORIES_BUSINESSES FOREIGN KEY (BusinessId) REFERENCES BUSINESSES(Id) ON DELETE CASCADE,
   CONSTRAINT FK_BUSINESS_CATEGORIES_TAGS FOREIGN KEY (CategoryId) REFERENCES CATEGORIES(Id) ON DELETE CASCADE
);


CREATE TABLE BUSINESS_HOURS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 BusinessId NUMBER(8,0) NOT NULL,
 Weekday NUMBER(1) CHECK (Weekday BETWEEN 0 AND 6), -- Monday=0
  -- The DATE type is used here only to represent TIME.
 -- Therefore, its day should always be '1970-01-01'
 OpeningTime DATE NOT NULL,
 ClosingTime DATE NOT NULL,
  CONSTRAINT CONST_FIXED_TIME_1 CHECK (TRUNC(OpeningTime) = DATE '1970-01-01'),
 CONSTRAINT CONST_FIXED_TIME_2 CHECK (TRUNC(ClosingTime) = DATE '1970-01-01'),


 CONSTRAINT PK_BUSINESS_HOURS PRIMARY KEY (Id),
 CONSTRAINT FK_BUSINESS_HOURS_BUSINESSES FOREIGN KEY (BusinessId) REFERENCES BUSINESSES(Id) ON DELETE CASCADE
);


CREATE TABLE CHECKINS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 BusinessId NUMBER(8,0) NOT NULL,
 Timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  CONSTRAINT PK_CHECKINS PRIMARY KEY (Id),
 CONSTRAINT FK_CHECKINS_BUSINESSES FOREIGN KEY (BusinessId) REFERENCES BUSINESSES(Id) ON DELETE CASCADE
);


-- Feedback-related data


CREATE TABLE FEEDBACKS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 UserId NUMBER(8,0) NOT NULL,
 BusinessId NUMBER(8,0) NOT NULL,
 Type VARCHAR2(10) NOT NULL CHECK (Type IN ('review', 'tip')),
 Rating NUMBER(1) CHECK (Rating BETWEEN 1 AND 5),
 Text VARCHAR2(1000),
 Timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  CONSTRAINT PK_FEEDBACKS PRIMARY KEY (Id),
 CONSTRAINT FK_FEEDBACKS_USERS FOREIGN KEY (UserId) REFERENCES USERS(Id) ON DELETE CASCADE,
 CONSTRAINT FK_FEEDBACKS_BUSINESSES FOREIGN KEY (BusinessId) REFERENCES BUSINESSES(Id) ON DELETE CASCADE
);


CREATE TABLE REACTION_TYPES (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 Name VARCHAR2(15) NOT NULL,
 CONSTRAINT PK_REACTION_TYPES PRIMARY KEY (Id)
);


CREATE TABLE REACTIONS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 UserId NUMBER(8,0), -- Note: data doesn't always contain user information
 FeedbackId NUMBER(8,0) NOT NULL,
 ReactionTypeId NUMBER(8,0),  -- Note: data doesn't always contain reaction type information
  CONSTRAINT PK_REACTIONS PRIMARY KEY (Id),
 CONSTRAINT FK_REACTIONS_USERS FOREIGN KEY (UserId) REFERENCES USERS(Id) ON DELETE CASCADE,
 CONSTRAINT FK_REACTIONS_FEEDBACKS FOREIGN KEY (FeedbackId) REFERENCES FEEDBACKS(Id) ON DELETE CASCADE,
 CONSTRAINT FK_REACTIONS_RTYPES FOREIGN KEY (ReactionTypeId) REFERENCES REACTION_TYPES(Id) ON DELETE CASCADE
);


-- Photo-related data


CREATE TABLE LABELS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 Name VARCHAR2(15) NOT NULL,
 CONSTRAINT PK_LABELS PRIMARY KEY (Id)
);


CREATE TABLE PHOTOS (
 Id NUMBER(8,0) GENERATED BY DEFAULT AS IDENTITY,
 UploaderId NUMBER(8,0),  -- Note: data does not contain uploader id
 BusinessId NUMBER(8,0) NOT NULL,
 LabelId NUMBER(8,0) NOT NULL,
 Data BLOB NOT NULL,
 Description VARCHAR2(140),
  CONSTRAINT PK_PHOTOS PRIMARY KEY (Id),
 CONSTRAINT FK_PHOTOS_UPLOADER FOREIGN KEY (UploaderId) REFERENCES USERS(Id) ON DELETE CASCADE,
 CONSTRAINT FK_PHOTOS_BUSINESSES FOREIGN KEY (BusinessId) REFERENCES BUSINESSES(Id) ON DELETE CASCADE,
 CONSTRAINT FK_PHOTOS_LABELS FOREIGN KEY (LabelId) REFERENCES LABELS(Id) ON DELETE CASCADE
)
LOB (Data) STORE AS LOB_photos (TABLESPACE ts_lob)
;


