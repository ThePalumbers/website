generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FeedbackType {
  review
  tip
}

enum FriendshipStatus {
  pending
  accepted
  rejected
}

model User {
  id               String       @id @db.Char(22) @map("Id")
  name             String       @db.VarChar(32) @map("Name")
  registrationDate DateTime     @default(now()) @map("RegistrationDate")

  feedbacks            Feedback[]
  reactions            Reaction[]
  uploadedPhotos       Photo[]          @relation("PhotoUploader")
  appAccounts          AppAccount[]
  sessions             AppSession[]
  friendshipsRequested Friendship[]     @relation("FriendshipRequester")
  friendshipsReceived  Friendship[]     @relation("FriendshipAddressee")

  @@map("USERS")
}

model Business {
  id                String             @id @db.Char(22) @map("Id")
  name              String             @db.VarChar(64) @map("Name")
  street            String?            @db.VarChar(120) @map("Street")
  city              String             @db.VarChar(64) @map("City")
  state             String             @db.VarChar(5) @map("State")
  postalCode        String?            @db.VarChar(10) @map("PostalCode")
  positionLatitude  Decimal?           @db.Decimal(10, 6) @map("PositionLatitude")
  positionLongitude Decimal?           @db.Decimal(10, 6) @map("PositionLongitude")

  businessTags       BusinessTag[]
  businessCategories BusinessCategory[]
  businessHours      BusinessHour[]
  checkins           Checkin[]
  feedbacks          Feedback[]
  photos             Photo[]

  @@index([city])
  @@map("BUSINESSES")
}

model Tag {
  id   String @id @db.Char(22) @map("Id")
  name String @db.VarChar(64) @map("Name")

  businessTags BusinessTag[]

  @@map("TAGS")
}

model Category {
  id   String @id @db.Char(22) @map("Id")
  name String @db.VarChar(64) @map("Name")

  businessCategories BusinessCategory[]

  @@map("CATEGORIES")
}

model BusinessTag {
  businessId String @db.Char(22) @map("BusinessId")
  tagId      String @db.Char(22) @map("TagId")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([businessId, tagId])
  @@map("BUSINESS_TAGS")
}

model BusinessCategory {
  businessId String @db.Char(22) @map("BusinessId")
  categoryId String @db.Char(22) @map("CategoryId")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([businessId, categoryId])
  @@map("BUSINESS_CATEGORIES")
}

model BusinessHour {
  id          String   @id @db.Char(22) @map("Id")
  businessId  String   @db.Char(22) @map("BusinessId")
  weekday     Int      @map("Weekday")
  openingTime DateTime @map("OpeningTime")
  closingTime DateTime @map("ClosingTime")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, weekday])
  @@map("BUSINESS_HOURS")
}

model Checkin {
  id         String   @id @db.Char(22) @map("Id")
  businessId String   @db.Char(22) @map("BusinessId")
  timestamp  DateTime @default(now()) @map("Timestamp")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, timestamp])
  @@map("CHECKINS")
}

model Feedback {
  id         String       @id @db.Char(22) @map("Id")
  type       FeedbackType @map("Type")
  userId     String       @db.Char(22) @map("UserId")
  businessId String       @db.Char(22) @map("BusinessId")
  rating     Int?         @map("Rating")
  text       String?      @db.VarChar(5000) @map("Text")
  timestamp  DateTime     @default(now()) @map("Timestamp")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  business  Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([businessId, timestamp])
  @@index([userId, timestamp])
  @@map("FEEDBACKS")
}

model ReactionType {
  id   String @id @db.Char(22) @map("Id")
  name String @db.VarChar(15) @map("Name")

  reactions Reaction[]

  @@map("REACTION_TYPES")
}

model Reaction {
  id             String  @id @db.Char(22) @map("Id")
  userId         String  @db.Char(22) @map("UserId")
  feedbackId     String  @db.Char(22) @map("FeedbackId")
  reactionTypeId String? @db.Char(22) @map("ReactionTypeId")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedback     Feedback     @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  reactionType ReactionType? @relation(fields: [reactionTypeId], references: [id], onDelete: Cascade)

  @@unique([userId, feedbackId])
  @@index([feedbackId])
  @@map("REACTIONS")
}

model Label {
  id   String @id @db.Char(22) @map("Id")
  name String @db.VarChar(15) @map("Name")

  photos Photo[]

  @@map("LABELS")
}

model Photo {
  id          String  @id @db.Char(22) @map("Id")
  uploaderId  String? @db.Char(22) @map("UploaderId")
  businessId  String  @db.Char(22) @map("BusinessId")
  data        Bytes   @map("Data")
  description String? @db.VarChar(140) @map("Description")
  labelId     String  @db.Char(22) @map("LabelId")

  uploader User?    @relation("PhotoUploader", fields: [uploaderId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  label    Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@map("PHOTOS")
}

model AppAccount {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @db.Char(22) @map("user_id")
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("APP_ACCOUNTS")
}

model AppSession {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Char(22) @map("user_id")
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("APP_SESSIONS")
}

model Friendship {
  id          String           @id @default(uuid()) @db.Uuid
  requesterId String           @db.Char(22) @map("requester_id")
  addresseeId String           @db.Char(22) @map("addressee_id")
  status      FriendshipStatus @default(pending)
  createdAt   DateTime         @default(now()) @map("created_at")
  respondedAt DateTime?        @map("responded_at")

  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee User @relation("FriendshipAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([status, requesterId])
  @@index([status, addresseeId])
  @@map("FRIENDSHIPS")
}
